<!DOCTYPE html>
<html lang='es'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>Dashboard de Proyecciones - An√°lisis Farmac√©utico</title>
    <script src='https://unpkg.com/react@18/umd/react.production.min.js'></script>
    <script src='https://unpkg.com/react-dom@18/umd/react-dom.production.min.js'></script>
    <script src='https://unpkg.com/@babel/standalone/babel.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js'></script>
    <link href='https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap' rel='stylesheet'>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #0A2540;
            --primary-light: #1A3A5C;
            --accent: #00D4FF;
            --accent-secondary: #7B61FF;
            --success: #00C896;
            --warning: #FFB020;
            --danger: #FF6B6B;
            --bg-dark: #0D1B2A;
            --bg-card: #1B2838;
            --text-primary: #E8F1F5;
            --text-secondary: #A8B8C8;
            --border: #2A3F54;
            --shadow: rgba(0, 212, 255, 0.1);
        }

        body {
            font-family: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0A1929 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .app-container {
            min-height: 100vh;
            padding: 1.5rem;
            max-width: 1900px;
            margin: 0 auto;
        }

        /* Compact Header with File Selector */
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 12px var(--shadow);
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-title h1 {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.02em;
        }

        .header-subtitle {
            color: var(--text-secondary);
            font-size: 0.75rem;
            font-family: 'Space Mono', monospace;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Compact File Upload */
        .file-upload-compact {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .upload-btn-compact {
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            color: var(--primary);
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.875rem;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .upload-btn-compact:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(0, 212, 255, 0.3);
        }

        .file-name-display {
            color: var(--success);
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-input {
            display: none;
        }

        /* Collapsible Filters Section */
        .filters-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 12px var(--shadow);
            overflow: hidden;
        }

        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            background: var(--primary-light);
            transition: background 0.3s ease;
        }

        .filters-header:hover {
            background: var(--primary);
        }

        .filters-header-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            font-family: 'Space Mono', monospace;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .filters-toggle {
            color: var(--accent);
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }

        .filters-toggle.open {
            transform: rotate(180deg);
        }

        .filters-body {
            padding: 1.5rem;
            display: none;
        }

        .filters-body.open {
            display: block;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-label {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-family: 'Space Mono', monospace;
        }

        .filter-select, .filter-multiselect {
            background: var(--primary-light);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.6rem;
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: all 0.3s ease;
            font-family: 'IBM Plex Sans', sans-serif;
        }

        .filter-select:focus, .filter-multiselect:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
        }

        .filter-multiselect {
            min-height: 80px;
        }

        /* Enhanced KPI Cards */
        .kpi-section {
            margin-bottom: 1.5rem;
        }

        .kpi-wrapper {
            display: flex;
            align-items: stretch;
            gap: 1rem;
        }

        .kpi-period-badge {
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            color: var(--primary);
            padding: 1.5rem 1.2rem;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1.5rem;
            font-family: 'Space Mono', monospace;
            box-shadow: 0 4px 20px rgba(0, 212, 255, 0.3);
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 180px;
            text-align: center;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .kpi-period-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--success), var(--warning));
        }

        .kpi-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            flex: 1;
        }

        .kpi-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px var(--shadow);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent), var(--accent-secondary));
        }

        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 32px var(--shadow);
        }

        .kpi-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-family: 'Space Mono', monospace;
            margin-bottom: 0.5rem;
        }

        .kpi-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.2;
            margin-bottom: 0.5rem;
        }

        .kpi-change {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .kpi-change.positive {
            color: var(--success);
        }

        .kpi-change.negative {
            color: var(--danger);
        }

        /* Charts Section */
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .charts-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px var(--shadow);
            transition: all 0.3s ease;
        }

        .chart-card:hover {
            box-shadow: 0 8px 32px var(--shadow);
        }

        .chart-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 1rem;
            font-family: 'Space Mono', monospace;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .chart-container {
            position: relative;
            height: 350px;
        }

        .chart-container.large {
            height: 400px;
        }

        /* Loading State */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(13, 27, 42, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 1400px) {
            .kpi-wrapper {
                flex-direction: column;
            }

            .kpi-period-badge {
                min-width: 100%;
                padding: 1rem;
                font-size: 1.25rem;
            }
        }

        @media (max-width: 1200px) {
            .charts-row {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .header-bar {
                flex-direction: column;
                gap: 1rem;
            }

            .kpi-container {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }

            .kpi-value {
                font-size: 1.8rem;
            }

            .kpi-period-badge {
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body>
    <div id='root'></div>

    <script type='text/babel'>
        const { useState, useEffect, useRef } = React;

        function Dashboard() {
            const [excelData, setExcelData] = useState(null);
            const [fileName, setFileName] = useState('');
            const [filters, setFilters] = useState({
                molecula: 'TODAS',
                ccaa: 'TODAS',
                especialidad: 'TODAS',
                periods: []
            });
            const [filtersOpen, setFiltersOpen] = useState(false);
            const [loading, setLoading] = useState(false);
            const [selectedPeriod, setSelectedPeriod] = useState(null); // Nuevo estado para periodo seleccionado

            const fileInputRef = useRef(null);

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                setLoading(true);
                setFileName(file.name);

                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const data = new Uint8Array(evt.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        
                        // Map column names to expected format
                        // IMPORTANTE: Usar valores PRECALCULADOS del archivo (columnas en AZUL)
                        // - HCP: columna 'HCP_PROY_NEW' (en lugar de HCP_MOL_Projected)
                        // - Depth: columna 'DEPTH_PROY' (valor precalculado)
                        // - Breadth: columna 'BREADTH_ESP_proy_new' (valor precalculado)
                        const mappedData = jsonData.map(row => ({
                            mes: row.MES || row.mes,
                            gardener: row.CCAA || row.gardener || 'N/A',
                            comparator_autorizada: row.MOLECULA || row.comparator_autorizada || 'N/A',
                            experiencia_hcp: row.especialidad_HCP || row.experiencia_hcp || 'N/A',
                            // COLUMNA AZUL: HCP_PROY_NEW (en lugar de HCP_MOL_Projected)
                            hcp_mdx_proyectado: Number(row.HCP_PROY_NEW || row.HCP_MOL_Projected || row.hcp_mdx_proyectado || 0),
                            pacientes_proyectados: Number(row['Patients (Projected)'] || row.pacientes_proyectados || 0),
                            rx_proyectadas: Number(row.RX_Projected || row.rx_proyectadas || 0),
                            // COLUMNA AZUL: DEPTH_PROY (valor precalculado, NO se calcula)
                            depth: Number(row.DEPTH_PROY || row.DEPTH_Projected || row.depth || 0),
                            // COLUMNA AZUL: BREADTH_ESP_proy_new (valor precalculado, ya viene como decimal)
                            breadth: Number(row.BREADTH_ESP_proy_new || row['Patient Depth (Rx per Patient)'] || row.breadth || 0),
                            novedosos: Number(row.HCP_MOL_SAMPLE || row.novedosos || 0),
                            // Columnas adicionales del archivo
                            tipoper: row.TIPOPER || 'N/A',
                            mercado: row.MERCADO || 'N/A',
                            segmento: row.SEGMENTO || 'N/A'
                        }));
                        
                        console.log('Datos mapeados:', mappedData.slice(0, 3));
                        setExcelData(mappedData);
                        
                        // Initialize periods filter with all available periods
                        const uniquePeriods = [...new Set(mappedData.map(row => row.mes))].filter(Boolean);
                        setFilters(prev => ({ ...prev, periods: uniquePeriods }));
                        
                        setLoading(false);
                    } catch (error) {
                        console.error('Error reading file:', error);
                        alert('Error al leer el archivo. Por favor, verifica el formato. Error: ' + error.message);
                        setLoading(false);
                    }
                };
                reader.readAsArrayBuffer(file);
            };

            const handleFilterChange = (filterName, value) => {
                setFilters(prev => ({
                    ...prev,
                    [filterName]: value
                }));
            };

            const handlePeriodMultiSelect = (e) => {
                const options = Array.from(e.target.selectedOptions);
                const selectedPeriods = options.map(option => option.value);
                setFilters(prev => ({ ...prev, periods: selectedPeriods }));
            };

            const getFilteredData = () => {
                if (!excelData) return [];

                return excelData.filter(row => {
                    const moleculaMatch = filters.molecula === 'TODAS' || 
                                         row.comparator_autorizada === filters.molecula;
                    const ccaaMatch = filters.ccaa === 'TODAS' || 
                                          row.gardener === filters.ccaa;
                    const especialidadMatch = filters.especialidad === 'TODAS' || 
                                          row.experiencia_hcp === filters.especialidad;
                    const periodMatch = filters.periods.length === 0 || 
                                       filters.periods.includes(row.mes);

                    return moleculaMatch && ccaaMatch && especialidadMatch && periodMatch;
                });
            };

            const calculateKPIs = (timeSeriesData, specificPeriod = null) => {
                if (!timeSeriesData || timeSeriesData.length === 0) {
                    return {
                        period: null,
                        totalHCP: { value: 0, change: 0 },
                        totalPatients: { value: 0, change: 0 },
                        totalRX: { value: 0, change: 0 },
                        avgDepth: { value: 0, change: 0 },
                        avgBreadth: { value: 0, change: 0 },
                        avgRxPerPatient: { value: 0, change: 0 }
                    };
                }

                // Si se especifica un periodo, buscar ese mes, sino usar el √∫ltimo
                let latestIndex;
                if (specificPeriod) {
                    latestIndex = timeSeriesData.findIndex(d => d.mes === specificPeriod);
                    if (latestIndex === -1) latestIndex = timeSeriesData.length - 1;
                } else {
                    latestIndex = timeSeriesData.length - 1;
                }

                const latest = timeSeriesData[latestIndex];
                const previous = latestIndex > 0 ? timeSeriesData[latestIndex - 1] : latest;

                const calcChange = (current, prev) => {
                    if (prev === 0) return 0;
                    return ((current - prev) / prev * 100);
                };

                return {
                    period: latest.mes,
                    totalHCP: {
                        value: Math.round(latest.hcp),
                        change: calcChange(latest.hcp, previous.hcp)
                    },
                    totalPatients: {
                        value: Math.round(latest.patients),
                        change: calcChange(latest.patients, previous.patients)
                    },
                    totalRX: {
                        value: Math.round(latest.rx),
                        change: calcChange(latest.rx, previous.rx)
                    },
                    avgDepth: {
                        value: latest.depth,
                        change: calcChange(latest.depth, previous.depth)
                    },
                    avgBreadth: {
                        value: latest.breadth,
                        change: calcChange(latest.breadth, previous.breadth)
                    },
                    avgRxPerPatient: {
                        value: latest.patients > 0 ? latest.rx / latest.patients : 0,
                        change: calcChange(
                            latest.patients > 0 ? latest.rx / latest.patients : 0,
                            previous.patients > 0 ? previous.rx / previous.patients : 0
                        )
                    }
                };
            };

            const getTimeSeriesData = (data) => {
                const grouped = {};
                
                data.forEach(row => {
                    const mes = row.mes;
                    if (!grouped[mes]) {
                        grouped[mes] = {
                            mes: mes,
                            hcp: 0,
                            patients: 0,
                            rx: 0,
                            depth: 0,      // Suma de valores precalculados
                            breadth: 0,    // Suma de valores precalculados
                            count: 0
                        };
                    }
                    
                    // HCP usa HCP_PROY_NEW (columna AZUL)
                    grouped[mes].hcp += Number(row.hcp_mdx_proyectado) || 0;
                    grouped[mes].patients += Number(row.pacientes_proyectados) || 0;
                    grouped[mes].rx += Number(row.rx_proyectadas) || 0;
                    // IMPORTANTE: Usar valores PRECALCULADOS del archivo (NO calcular)
                    // DEPTH_PROY (columna AZUL)
                    grouped[mes].depth += Number(row.depth) || 0;
                    // BREADTH_ESP_proy_new (columna AZUL)
                    grouped[mes].breadth += Number(row.breadth) || 0;
                    grouped[mes].count++;
                });

                return Object.values(grouped)
                    .map(item => ({
                        mes: item.mes,
                        hcp: item.hcp,
                        patients: item.patients,
                        rx: item.rx,
                        // Promediar los valores precalculados del archivo (NO calcular)
                        depth: item.depth / item.count,
                        breadth: item.breadth / item.count  // Se mostrar√° como % multiplicando x100
                    }))
                    .sort((a, b) => {
                        const [aYear, aMonth] = a.mes.split('/').map(Number);
                        const [bYear, bMonth] = b.mes.split('/').map(Number);
                        return aYear !== bYear ? aYear - bYear : aMonth - bMonth;
                    });
            };

            const filteredData = getFilteredData();
            const timeSeriesData = getTimeSeriesData(filteredData);
            const kpis = calculateKPIs(timeSeriesData, selectedPeriod);

            const getUniqueValues = (field) => {
                if (!excelData) return [];
                return ['TODAS', ...new Set(excelData.map(row => row[field]).filter(Boolean))];
            };

            const getUniqueExperiences = () => {
                if (!excelData) return [];
                return ['TODAS', ...new Set(excelData.map(row => row.experiencia_hcp).filter(Boolean))];
            };

            const getAllPeriods = () => {
                if (!excelData) return [];
                return [...new Set(excelData.map(row => row.mes).filter(Boolean))].sort((a, b) => {
                    const [aYear, aMonth] = a.split('/').map(Number);
                    const [bYear, bMonth] = b.split('/').map(Number);
                    return aYear !== bYear ? aYear - bYear : aMonth - bMonth;
                });
            };

            return (
                <div className='app-container'>
                    {loading && (
                        <div className='loading-overlay'>
                            <div className='loading-spinner'></div>
                        </div>
                    )}

                    {/* Compact Header with File Upload */}
                    <div className='header-bar'>
                        <div className='header-title'>
                            <div>
                                <h1>Dashboard de Proyecciones</h1>
                                <p className='header-subtitle'>An√°lisis de HCPs y Proyecciones</p>
                            </div>
                        </div>
                        <div className='file-upload-compact'>
                            {fileName && <span className='file-name-display'>üìä {fileName}</span>}
                            <button 
                                className='upload-btn-compact'
                                onClick={() => fileInputRef.current?.click()}
                            >
                                {fileName ? 'Cambiar Archivo' : 'Cargar Excel'}
                            </button>
                            <input
                                ref={fileInputRef}
                                type='file'
                                className='file-input'
                                accept='.xlsx,.xls'
                                onChange={handleFileUpload}
                            />
                        </div>
                    </div>

                    {excelData && (
                        <>
                            {/* Collapsible Filters */}
                            <div className='filters-section'>
                                <div 
                                    className='filters-header'
                                    onClick={() => setFiltersOpen(!filtersOpen)}
                                >
                                    <span className='filters-header-title'>
                                        üîç Filtros de An√°lisis
                                    </span>
                                    <span className={`filters-toggle ${filtersOpen ? 'open' : ''}`}>
                                        ‚ñº
                                    </span>
                                </div>
                                <div className={`filters-body ${filtersOpen ? 'open' : ''}`}>
                                    <div className='filters-grid'>
                                        <div className='filter-group'>
                                            <label className='filter-label'>Mol√©cula</label>
                                            <select
                                                className='filter-select'
                                                value={filters.molecula}
                                                onChange={(e) => handleFilterChange('molecula', e.target.value)}
                                            >
                                                <option value='TODAS'>Todas las Mol√©culas</option>
                                                {getUniqueValues('comparator_autorizada').filter(v => v !== 'TODAS').map(val => (
                                                    <option key={val} value={val}>{val}</option>
                                                ))}
                                            </select>
                                        </div>

                                        <div className='filter-group'>
                                            <label className='filter-label'>Comunidad Aut√≥noma</label>
                                            <select
                                                className='filter-select'
                                                value={filters.ccaa}
                                                onChange={(e) => handleFilterChange('ccaa', e.target.value)}
                                            >
                                                <option value='TODAS'>Todas las CCAAs</option>
                                                {getUniqueValues('gardener').filter(v => v !== 'TODAS').map(val => (
                                                    <option key={val} value={val}>{val}</option>
                                                ))}
                                            </select>
                                        </div>

                                        <div className='filter-group'>
                                            <label className='filter-label'>Especialidad HCP</label>
                                            <select
                                                className='filter-select'
                                                value={filters.especialidad}
                                                onChange={(e) => handleFilterChange('especialidad', e.target.value)}
                                            >
                                                <option value='TODAS'>Todas las Especialidades</option>
                                                {getUniqueExperiences().filter(v => v !== 'TODAS').map(val => (
                                                    <option key={val} value={val}>{val}</option>
                                                ))}
                                            </select>
                                        </div>

                                        <div className='filter-group'>
                                            <label className='filter-label'>Periodos (Selecci√≥n m√∫ltiple)</label>
                                            <select
                                                className='filter-multiselect'
                                                multiple
                                                value={filters.periods}
                                                onChange={handlePeriodMultiSelect}
                                            >
                                                {getAllPeriods().map(period => (
                                                    <option key={period} value={period}>{period}</option>
                                                ))}
                                            </select>
                                            <small style={{color: 'var(--text-secondary)', fontSize: '0.7rem'}}>
                                                Mant√©n Ctrl/Cmd para seleccionar m√∫ltiples
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* KPI Section with Period Badge */}
                            <div className='kpi-section'>
                                <div className='kpi-wrapper'>
                                    <div className='kpi-period-badge'>
                                        üìÖ {kpis.period || 'N/A'}
                                    </div>
                                    <div className='kpi-container'>
                                        <KPICard
                                            label='HCPs Proyectados'
                                            value={formatNumber(kpis.totalHCP.value)}
                                            change={kpis.totalHCP.change.toFixed(1) + '%'}
                                            positive={kpis.totalHCP.change >= 0}
                                        />
                                        <KPICard
                                            label='Pacientes Proyectados'
                                            value={formatNumber(kpis.totalPatients.value)}
                                            change={kpis.totalPatients.change.toFixed(1) + '%'}
                                            positive={kpis.totalPatients.change >= 0}
                                        />
                                        <KPICard
                                            label='RX Proyectadas'
                                            value={formatNumber(kpis.totalRX.value)}
                                            change={kpis.totalRX.change.toFixed(1) + '%'}
                                            positive={kpis.totalRX.change >= 0}
                                        />
                                        <KPICard
                                            label='Depth (Rx/HCP)'
                                            value={kpis.avgDepth.value.toFixed(2)}
                                            change={kpis.avgDepth.change.toFixed(1) + '%'}
                                            positive={kpis.avgDepth.change >= 0}
                                        />
                                        <KPICard
                                            label='Breadth (%)'
                                            value={(kpis.avgBreadth.value * 100).toFixed(2) + '%'}
                                            change={kpis.avgBreadth.change.toFixed(1) + '%'}
                                            positive={kpis.avgBreadth.change >= 0}
                                        />
                                        <KPICard
                                            label='Rx/Paciente'
                                            value={kpis.avgRxPerPatient.value.toFixed(2)}
                                            change={kpis.avgRxPerPatient.change.toFixed(1) + '%'}
                                            positive={kpis.avgRxPerPatient.change >= 0}
                                        />
                                    </div>
                                </div>
                            </div>

                            {/* Charts */}
                            <div className='charts-grid'>
                                {/* Main Time Series Chart - Full Width */}
                                <div className='chart-card'>
                                    <h3 className='chart-title'>Evoluci√≥n Temporal - HCPs, Pacientes y RX</h3>
                                    <div className='chart-container large'>
                                        <TimeSeriesChart 
                                            data={timeSeriesData} 
                                            onPeriodClick={setSelectedPeriod}
                                        />
                                    </div>
                                </div>

                                {/* Bottom Row - Two Charts */}
                                <div className='charts-row'>
                                    <div className='chart-card'>
                                        <h3 className='chart-title'>M√©tricas de Eficiencia</h3>
                                        <div className='chart-container'>
                                            <EfficiencyChart data={timeSeriesData} />
                                        </div>
                                    </div>

                                    <div className='chart-card'>
                                        <h3 className='chart-title'>Tendencia de Crecimiento (vs A√±o Anterior)</h3>
                                        <div className='chart-container'>
                                            <YearOverYearGrowthChart data={timeSeriesData} />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </>
                    )}

                    {!excelData && !loading && (
                        <div style={{
                            textAlign: 'center',
                            padding: '4rem',
                            color: 'var(--text-secondary)'
                        }}>
                            <div style={{fontSize: '4rem', marginBottom: '1rem'}}>üìä</div>
                            <h2 style={{color: 'var(--accent)', marginBottom: '0.5rem'}}>
                                Carga un archivo Excel para comenzar
                            </h2>
                            <p>Haz clic en 'Cargar Excel' en la parte superior</p>
                        </div>
                    )}
                </div>
            );
        }

        function KPICard({ label, value, change, positive }) {
            return (
                <div className='kpi-card'>
                    <div className='kpi-label'>{label}</div>
                    <div className='kpi-value'>{value}</div>
                    <div className={`kpi-change ${positive ? 'positive' : 'negative'}`}>
                        <span>{positive ? '‚Üë' : '‚Üì'}</span>
                        <span>{change}</span>
                    </div>
                </div>
            );
        }

        function TimeSeriesChart({ data, onPeriodClick }) {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (chartRef.current) {
                    chartRef.current.destroy();
                }

                const ctx = canvasRef.current.getContext('2d');
                chartRef.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map(d => d.mes),
                        datasets: [
                            {
                                label: 'HCP (MDX Proyectado)',
                                data: data.map(d => d.hcp),
                                borderColor: '#00D4FF',
                                backgroundColor: 'rgba(0, 212, 255, 0.1)',
                                borderWidth: 3,
                                tension: 0.4,
                                fill: true,
                                pointRadius: 4,
                                pointHoverRadius: 6
                            },
                            {
                                label: 'Pacientes (Proyectados)',
                                data: data.map(d => d.patients),
                                borderColor: '#7B61FF',
                                backgroundColor: 'rgba(123, 97, 255, 0.1)',
                                borderWidth: 3,
                                tension: 0.4,
                                fill: true,
                                pointRadius: 4,
                                pointHoverRadius: 6
                            },
                            {
                                label: 'RX (Proyectadas)',
                                data: data.map(d => d.rx),
                                borderColor: '#00C896',
                                backgroundColor: 'rgba(0, 200, 150, 0.1)',
                                borderWidth: 3,
                                tension: 0.4,
                                fill: true,
                                pointRadius: 4,
                                pointHoverRadius: 6
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        onClick: (event, activeElements) => {
                            if (activeElements.length > 0 && onPeriodClick) {
                                const index = activeElements[0].index;
                                const clickedPeriod = data[index].mes;
                                onPeriodClick(clickedPeriod);
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    color: '#E8F1F5',
                                    font: {
                                        family: 'IBM Plex Sans, sans-serif',
                                        size: 12,
                                        weight: '500'
                                    },
                                    padding: 15
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(27, 40, 56, 0.95)',
                                titleColor: '#00D4FF',
                                bodyColor: '#E8F1F5',
                                borderColor: '#2A3F54',
                                borderWidth: 1,
                                padding: 12,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        // Formatear sin decimales
                                        label += Math.round(context.parsed.y).toLocaleString('es-ES');
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: '#2A3F54',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: '#A8B8C8',
                                    font: {
                                        family: 'Space Mono, monospace',
                                        size: 11
                                    }
                                }
                            },
                            y: {
                                grid: {
                                    color: '#2A3F54',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: '#A8B8C8',
                                    font: {
                                        family: 'Space Mono, monospace',
                                        size: 11
                                    }
                                }
                            }
                        }
                    }
                });

                return () => {
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }
                };
            }, [data]);

            return <canvas ref={canvasRef}></canvas>;
        }

        function EfficiencyChart({ data }) {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (chartRef.current) {
                    chartRef.current.destroy();
                }

                const ctx = canvasRef.current.getContext('2d');
                chartRef.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map(d => d.mes),
                        datasets: [
                            {
                                label: 'Depth',
                                data: data.map(d => d.depth),
                                borderColor: '#FFB020',
                                backgroundColor: 'rgba(255, 176, 32, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                yAxisID: 'y',
                                pointRadius: 3
                            },
                            {
                                label: 'Breadth (%)',
                                data: data.map(d => d.breadth * 100),
                                borderColor: '#FF6B6B',
                                backgroundColor: 'rgba(255, 107, 107, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                yAxisID: 'y1',
                                pointRadius: 3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#E8F1F5',
                                    font: {
                                        family: 'IBM Plex Sans, sans-serif',
                                        size: 11
                                    }
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(27, 40, 56, 0.95)',
                                titleColor: '#00D4FF',
                                bodyColor: '#E8F1F5',
                                borderColor: '#2A3F54',
                                borderWidth: 1,
                                padding: 12,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        // Depth sin decimales, Breadth con 1 decimal
                                        if (context.dataset.label === 'Depth') {
                                            label += Math.round(context.parsed.y).toLocaleString('es-ES');
                                        } else {
                                            label += context.parsed.y.toFixed(1) + '%';
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: '#2A3F54',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: '#A8B8C8',
                                    font: {
                                        family: 'Space Mono, monospace',
                                        size: 10
                                    }
                                }
                            },
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                grid: {
                                    color: '#2A3F54',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: '#FFB020',
                                    font: {
                                        family: 'Space Mono, monospace',
                                        size: 10
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Depth',
                                    color: '#FFB020'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                grid: {
                                    drawOnChartArea: false
                                },
                                ticks: {
                                    color: '#FF6B6B',
                                    font: {
                                        family: 'Space Mono, monospace',
                                        size: 10
                                    },
                                    callback: function(value) {
                                        return value.toFixed(1) + '%';
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Breadth (%)',
                                    color: '#FF6B6B'
                                }
                            }
                        }
                    }
                });

                return () => {
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }
                };
            }, [data]);

            return <canvas ref={canvasRef}></canvas>;
        }

        function YearOverYearGrowthChart({ data }) {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (chartRef.current) {
                    chartRef.current.destroy();
                }

                // Group data by year and month
                const dataByYearMonth = {};
                data.forEach(item => {
                    const [year, month] = item.mes.split('/');
                    if (!dataByYearMonth[month]) {
                        dataByYearMonth[month] = {};
                    }
                    dataByYearMonth[month][year] = {
                        hcp: item.hcp,
                        patients: item.patients,
                        rx: item.rx
                    };
                });

                // Calculate year-over-year comparison
                const months = Object.keys(dataByYearMonth).sort((a, b) => Number(a) - Number(b));
                const years = [...new Set(data.map(d => d.mes.split('/')[0]))].sort();
                
                const datasets = [];
                
                // Create datasets for each year
                years.forEach((year, index) => {
                    const colors = ['#00D4FF', '#7B61FF', '#00C896', '#FFB020', '#FF6B6B'];
                    const color = colors[index % colors.length];
                    
                    datasets.push({
                        label: `A√±o ${year} - HCP`,
                        data: months.map(month => {
                            return dataByYearMonth[month][year]?.hcp || null;
                        }),
                        borderColor: color,
                        backgroundColor: color,
                        borderWidth: 3,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    });
                });

                const ctx = canvasRef.current.getContext('2d');
                chartRef.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: months.map(m => {
                            const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 
                                              'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                            return monthNames[Number(m) - 1];
                        }),
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    color: '#E8F1F5',
                                    font: {
                                        family: 'IBM Plex Sans, sans-serif',
                                        size: 11,
                                        weight: '500'
                                    },
                                    padding: 10
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(27, 40, 56, 0.95)',
                                titleColor: '#00D4FF',
                                bodyColor: '#E8F1F5',
                                borderColor: '#2A3F54',
                                borderWidth: 1,
                                padding: 12,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            // Formatear sin decimales
                                            label += Math.round(context.parsed.y).toLocaleString('es-ES');
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: '#2A3F54',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: '#A8B8C8',
                                    font: {
                                        family: 'Space Mono, monospace',
                                        size: 10
                                    }
                                }
                            },
                            y: {
                                grid: {
                                    color: '#2A3F54',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: '#A8B8C8',
                                    font: {
                                        family: 'Space Mono, monospace',
                                        size: 10
                                    }
                                }
                            }
                        }
                    }
                });

                return () => {
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }
                };
            }, [data]);

            return <canvas ref={canvasRef}></canvas>;
        }

        function formatNumber(num, decimals = 0) {
            if (num === null || num === undefined) return '-';
            return num.toLocaleString('es-ES', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });
        }

        ReactDOM.render(<Dashboard />, document.getElementById('root'));
    </script>
</body>
</html>
